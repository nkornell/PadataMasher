<html>

<head>
	<title>Reference Analyzer</title>
	<meta charset="UTF-8">
	<meta name="description" content="looking at academic references">
	<meta name="keywords" content="program">
	<meta name="author" content="Nate Kornell">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="stylesheet" type="text/css" href="mystyle.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<script>
	var urls = [];
	var authors = [];
	
	function json_practice() {
		var output = "";
		var authorList = "";
		var numResultsToShow = 1;
		var titleArray = [];
		authors = [];
		
		// map each url to a getJSON call
		var proms = urls.map(url=>$.getJSON(url));

		// put the results in a table
		Promise.all(proms).then(function(data){
			for (i = 0; i < data.length; i++) {
				output = "";
				for (j = 0; j < numResultsToShow; j++) {
					authorList = "";
					
					// if crossref didn't find it, ignore it
					if (typeof data[i].message.items[j].author === 'undefined') {
						authorList = "not found";
					} else {
						// if this is already in the list, ignore it
						if (titleArray.includes(data[i].message.items[j].title[0]) == true) {
							authorList = "duplicate";
						} else {
							// figure out authors
							titleArray.push(data[i].message.items[j].title[0]);

							for (a = 0; a < data[i].message.items[j].author.length; a++) {
								tempAuthor = data[i].message.items[j].author[a].family + ", ";
								tempAuthor += data[i].message.items[j].author[a].given;
								authorList += tempAuthor + "; ";
					
								// keep track of all of the authors (who had the top score)
								if (j == 0) {
									if (authors[tempAuthor] === undefined) {
										authors[tempAuthor] = 1;
									} else {
										authors[tempAuthor]++;
									} 
								}
							}
						}
					}
 					
					// assign value to output
					if (authorList == "not found" || authorList == "duplicate") {
						output += "<p>" + authorList;
					} else {
						output += "<p>" + authorList + data[i].message.items[j].title + " " +data[i].message.items[j].URL ;
					}
				}
				document.getElementById(urls[i]).innerHTML = output;
			}
			showAuthors();
		});
	}
	
	function showAuthors() {
		var authorTableText = "<table>"
		var authorArrayTemp = [];
		
		// authors is an object. in order to sort it, first turn the author names into an array.
		for (var key in authors) {
			if (authors.hasOwnProperty(key)) {
				authorArrayTemp.push(key);
			}
		}
		
		authorArrayTemp.sort();
		
		// add authors to the html table
		for (i = 0; i < authorArrayTemp.length; i++) {
			authorTableText += "<tr><td>";
			authorTableText += authorArrayTemp[i] + "</td><td>" + authors[authorArrayTemp[i]];
			authorTableText += "</td></tr>";
		}

		authorTableText += "</table>"
		document.getElementById('authorTable').innerHTML = authorTableText;
	}
	

	
	function showBoxes() {
		var x = document.getElementById("refalyzerArticleListBox");
		x.style.display = "flex";
		x = document.getElementById("refalyzerAuthorsBox");
		x.style.display = "flex";
	}
	
	function getText() {
		showBoxes();
		parse_input();
		json_practice();
	}
	
	function parse_input() {
		urls = [];

		var inputText = document.getElementById("myText").value;		
		inputText = inputText.replaceAll('&', '');
		
		var inputRow = inputText.split(/\r\n|\r|\n/g);
		
		// get rid of rows with too few characters
		for (i = inputRow.length - 1; i >= 0; i--) {
			inputRow[i] = inputRow[i].trim();
			if (inputRow[i].length < 5) {
				inputRow.splice(i, 1);
			}
		}
		
		// Fill in urls variable
		for (i = 0; i < inputRow.length; i++) { 
			urls.push('https://api.crossref.org/works?mailto=nkornell@gmail.com&rows=2&query.bibliographic=' + inputRow[i].replaceAll(' ', '+'));
		}
		
		// Build article table
		var articleTableText = "<table>";
		articleTableText += '<tr><th style="width:50%">Search text</th>';
    	articleTableText += '<th style="width:50%">Article found</th></tr>';

		for (i = 0; i < inputRow.length; i++) {
			articleTableText += "<tr><td>";
			articleTableText += inputRow[i];
			articleTableText += "</td><td>";
			articleTableText += "<div id='"+urls[i]+"'>searching...</div>";
			articleTableText += "</td></tr>";
		}
		articleTableText += "</table>";
		document.getElementById('articleTable').innerHTML = articleTableText;
		
		document.getElementById('authorTable').innerHTML = "<table><tr><td>searching...</td></tr></table>";
	}
</script>
</head>


<body>

	<!--  navigation menu -->
	<nav>
		<ul>
			<li><a href="index.html"><div class="navMenuItem"><img src="images/pm.png" > Masher Home</div></a></li>
			<li><a href="index_CombineAndClean.html"><div class="navMenuItem"><img src="images/cac.png"> Combine Datafiles</div></a></li>
			<li><a href="index_StatBuddy.html"><div class="navMenuItem"><img src="images/ptp.png"> StatBuddy</div></a></li>
			<li style="float:right"><a href="index_About.html"><div class="navMenuItem">About</div></a></li>
		</ul>
	</nav>

<!-- new stuff -->
<textarea id="myText" name="inputTextArea" rows="20" cols="80">
kornell klein rawson
</textarea>
<!-- Kornell, N. (2014b). Where is the “meta” in animal metacognition? Journal of Comparative Psychology, 128, 143-149. doi:10.1037/a0033444
 -->

<p>
<button onclick="getText()">Run</button>

<!-- <p id="outputText"></p> -->

<!-- 	Results preview table 	-->
<div class='bigBox' id='refalyzerArticleListBox' style="display: none">
	<div class='bigBox' display="block"> 
		<div class='boxAroundTable'>
			<div class='heading'>Articles</div><br>
			<p>
			<div id='articleTable' class='dataTable'></div>
		</div>
	</div>
</div>

<div class='bigBox' id='refalyzerAuthorsBox' style="display: none">
	<div class='bigBox' display="block"> 
		<div class='boxAroundTable'>
			<div class='heading'>Authors</div><br>
			<p>
			<div id='authorTable' class='dataTable'></div>
		</div>
	</div>
</div>


<!-- end new stuff -->











	<!-- Export button -->
	<div class='boxAroundTable'>
		<div class="clearfix">
			<div style='float: right;'>
				<a id="exportButton" class='coolButton'>Export Data</a>
			</div>
		</div>
	</div>


</body>
</html>

<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~- -->


<!-- <script src="file_select.js"></script> -->
<script src="file_importExportContent.js"></script>
<!-- <script src="functions_fileOverlap.js"></script> -->
<!-- <script src="functions_stats.js"></script> -->
<!-- <script src="functions_indexpage.js"></script> -->